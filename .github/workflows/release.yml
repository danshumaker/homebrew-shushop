name: Auto Update Homebrew Formula on Tag

on:
  push:
    tags:
      - "*"

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0 # required for tag info

      - name: Extract version from tag
        id: vars
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download GitHub-generated tarball
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          URL="https://github.com/danshumaker/homebrew-denver/archive/refs/tags/${VERSION}.tar.gz"
          echo "Fetching: $URL"
          curl -L "$URL" -o source.tar.gz

      - name: Compute SHA256
        id: sha
        run: |
          SHA=$(shasum -a 256 source.tar.gz | awk '{print $1}')
          echo "sha256=$SHA" >> $GITHUB_OUTPUT

      - name: Update Formula
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          SHA="${{ steps.sha.outputs.sha256 }}"

          sed -i "s/^  version \".*\"/  version \"${VERSION}\"/" Formula/denver.rb
          sed -i "s/^  sha256 \".*\"/  sha256 \"${SHA}\"/" Formula/denver.rb

      - name: Commit updated formula
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          SHA="${{ steps.sha.outputs.sha256 }}"
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add Formula/denver.rb
          git commit -m "GitHub-Actions: Auto-update formula for version $VERSION with $SHA"
          git push origin main
